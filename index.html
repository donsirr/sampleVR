<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VR GLB Teleport + Movement Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <a-scene 
      shadow="type: pcfsoft"
      fog="type: linear; color: #e0e0e0; near: 1; far: 50;"
    >
      <!-- Lighting -->
      <a-entity light="type: ambient; intensity: 0.5"></a-entity>
      <a-entity
        light="type: directional; intensity: 0.5; castShadow: true"
        position="5 5 5"
        target="#cameraRig"
      ></a-entity>
      
      <!-- Camera rig -->
      <a-entity 
        id="cameraRig" 
        position="0 0.5 22.5"
        movement-controls="fly: true; speed: 0"
        gamepad-controls="controller: 0; enableSettings: true"
      >
        <a-camera look-controls position="0 0 0">
          <a-cursor fuse="true" fuse-timeout="500" color="white"></a-cursor>
        </a-camera>

        <!-- Teleport -->
        <a-entity
          teleport-controls="button: trigger; collisionEntities: .teleportable; cameraRig: #cameraRig"
        ></a-entity>
      </a-entity>

      <!-- Ground or environment -->
      

      <!-- GLB Model -->
      <a-entity
        gltf-model="url(klyde the goat 3.glb)"
        position="0 0 0"
        animation-mixer
        scale="1.5 1.5 1.5"
        class="teleportable"
        shadow="cast: true; receive: true"
      ></a-entity>
    </a-scene>

<script>
  // === Basic setup ===
  const rig = document.querySelector('#cameraRig');
  const camera = rig.querySelector('a-camera');
  let moveDirection = 0; // 1 = forward, -1 = backward
  let speed = 0.05; // base speed per frame

  // --- Movement function ---
  function moveRig() {
    if (moveDirection === 0) return;

    const rotation = camera.getAttribute('rotation');
    const angle = THREE.MathUtils.degToRad(rotation.y);
    const dx = -Math.sin(angle) * moveDirection * speed;
    const dz = -Math.cos(angle) * moveDirection * speed;
    const pos = rig.getAttribute('position');
    pos.x += dx;
    pos.z += dz;
    rig.setAttribute('position', pos);
  }

  // --- Continuous update loop ---
  function animate() {
    moveRig();
    handleGamepadInput(); // check controller each frame
    requestAnimationFrame(animate);
  }
  animate();

  // --- Mouse controls (desktop) ---
  window.addEventListener('mousedown', (e) => {
    if (e.button === 0) moveDirection = 1;   // left click → forward
    if (e.button === 2) moveDirection = -1;  // right click → backward
  });
  window.addEventListener('mouseup', () => (moveDirection = 0));
  window.addEventListener('mouseleave', () => (moveDirection = 0));
  window.addEventListener('contextmenu', (e) => e.preventDefault());

  // --- Touch controls (mobile) ---
  window.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) moveDirection = 1; // one finger → forward
    else if (e.touches.length === 2) moveDirection = -1; // two fingers → back
  });
  window.addEventListener('touchend', () => (moveDirection = 0));

  // --- Jump button (PS4 X) ---
  window.addEventListener('gamepadbuttondown', (e) => {
    if (e.detail.index === 0) { // X button
      const pos = rig.getAttribute('position');
      pos.y += 1;
      rig.setAttribute('position', pos);
      setTimeout(() => {
        pos.y -= 1;
        rig.setAttribute('position', pos);
      }, 500);
    }
  });

  // === PS4 Controller Movement (Bluetooth) ===
  // Poll the Gamepad API each frame
  function handleGamepadInput() {
    const gamepads = navigator.getGamepads
      ? navigator.getGamepads()
      : [];

    if (!gamepads) return;

    const gp = gamepads[0]; // assume first connected controller
    if (!gp) return;

    // Left stick vertical axis (index 1): -1 = forward, 1 = backward
    const vertical = gp.axes[1];
    const deadzone = 0.2;

    if (Math.abs(vertical) > deadzone) {
      moveDirection = vertical < 0 ? 1 : -1;
    } else {
      moveDirection = 0;
    }

    // Optional: Right trigger (R2) to sprint
    const r2 = gp.buttons[7];
    if (r2 && r2.value > 0.2) {
      speed = 0.15; // sprint speed
    } else {
      speed = 0.05; // normal speed
    }
  }

  // --- Helpful logging ---
  window.addEventListener('gamepadconnected', (e) => {
    console.log('PS4 Controller connected:', e.gamepad.id);
  });
  window.addEventListener('gamepaddisconnected', () => {
    console.log('PS4 Controller disconnected');
  });

  // --- Middle mouse button reload ---
  window.addEventListener('mousedown', (e) => {
    if (e.button === 1) {
      // Prevent accidental text selection
      e.preventDefault();
      // Reload the page
      location.reload();
    }
  });

</script>


  </body>
</html>
